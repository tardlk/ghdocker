name: åŒæ­¥ Docker é•œåƒ â†’ ghcr.io
permissions:
  packages: write
  contents: write
on:
  workflow_dispatch:
    inputs:
      images:
        description: "è¦åŒæ­¥çš„ Docker é•œåƒåˆ—è¡¨ï¼Œæ ¼å¼ä¸º 'é•œåƒ1:æ ‡ç­¾1,é•œåƒ2:æ ‡ç­¾2,é•œåƒ3:æ ‡ç­¾3'"
        required: true
        default: ""
      ghcr_names:
        description: "å¯¹åº”çš„åŒæ­¥åçš„é•œåƒåç§°åˆ—è¡¨ï¼Œæ ¼å¼ä¸º 'åç§°1,åç§°2,åç§°3'ï¼Œå¦‚æœæŸä¸ªé•œåƒä¸éœ€è¦æŒ‡å®šåç§°ï¼Œåˆ™ç”¨é€—å·å¡«å……ï¼Œä¾‹å¦‚ ',,my-image' è¡¨ç¤ºç¬¬ä¸‰ä¸ªé•œåƒåŒæ­¥ååç§°ä¸º my-imageï¼Œå‰ä¸¤ä¸ªè‡ªåŠ¨æå–"
        required: false
        default: ""
      change_tag_to_latest:
        description: "åŒæ­¥åæ˜¯å¦å°†é•œåƒæ ‡ç­¾æ”¹ä¸º latest (æ˜¯/å¦)"
        required: true
        type: choice
        options:
          - "æ˜¯"
          - "å¦"
        default: "æ˜¯"
jobs:
  docker-image-sync:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: sudo apt-get update && sudo apt-get install -y jq skopeo
      
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è®¾ç½® GHCR_USER ç¯å¢ƒå˜é‡
        id: set_ghcr_user
        run: echo "GHCR_USER=${{ github.actor }}" >> $GITHUB_ENV
      
      - name: ç™»å½•åˆ° GitHub å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USER }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: åŒæ­¥é•œåƒå¹¶æ›´æ–° READMEï¼ˆä¿®å¤è¯­æ³•æŠ¥é”™ç‰ˆï¼‰
        run: |
          # åˆå§‹åŒ– Git é…ç½®
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase

          # --- 1. åˆå§‹åŒ–åŸºç¡€æ¨¡æ¿ï¼ˆç¡®ä¿ example.yaml å­˜åœ¨ï¼‰---
          mkdir -p docker-compose
          if [ ! -f "docker-compose/example.yaml" ]; then
            echo "âš ï¸ æœªæ‰¾åˆ° docker-compose/example.yamlï¼Œè‡ªåŠ¨ç”ŸæˆåŸºç¡€æ¨¡æ¿"
            cat > docker-compose/example.yaml << 'EOF'
          version: '3.8'
          services:
            app:
              image: ghcr.io/USER/IMAGE:TAG
              container_name: app-container
              restart: unless-stopped
              # å¯æŒ‰éœ€æ·»åŠ ä»¥ä¸‹é…ç½®
              # volumes:
              #   - ./data:/app/data
              # ports:
              #   - "8080:8080"
              # environment:
              #   - TZ=Asia/Shanghai
          EOF
            sed -i "s/ghcr.io\/USER/ghcr.io\/${{ env.GHCR_USER }}/g" docker-compose/example.yaml
          fi

          # --- 2. é•œåƒåŒæ­¥æ ¸å¿ƒé€»è¾‘ï¼ˆæ”¯æŒåµŒå¥—ç›®å½•+é‡è¯•æœºåˆ¶ï¼‰---
          NEW_ROWS_DATA=""
          UNIQUE_SEPARATOR="%%%"
          TABLE_TITLE="### å·²åŒæ­¥çš„ Docker é•œåƒ"
          
          # æå– README ä¸­å·²å­˜åœ¨çš„æºé•œåƒï¼ˆä¸¥æ ¼åŒ¹é…ï¼Œé¿å…é‡å¤åŒæ­¥ï¼‰
          existing_source_images=$(awk '
            $0 == "'"${TABLE_TITLE}"'" { in_table=1; next }
            in_table {
              if (/^\| [0-9]/) { 
                # æå–ç¬¬2åˆ—ï¼ˆæºé•œåƒï¼‰å†…å®¹ï¼Œæ¸…ç†ç©ºæ ¼
                match($0, /\| *[^|]+ *\| *([^|]+) *\|/);
                if (RSTART) {
                  src_img = substr($0, RSTART+RLENGTH-length(substr($0, RSTART, RLENGTH))+2, RLENGTH-4);
                  gsub(/^[ \t]*|[ \t]*$/, "", src_img);
                  print src_img
                }
              }
              if (!/^\|/ && !/^$/) { in_table=0 }
            }
          ' README.md)

          # è§£æè¾“å…¥å‚æ•°ä¸ºæ•°ç»„
          IFS=',' read -r -a image_array <<< "${{ inputs.images }}"
          IFS=',' read -r -a ghcr_name_array <<< "${{ inputs.ghcr_names }}"

          for i in "${!image_array[@]}"; do
            full_image=$(echo "${image_array[$i]}" | xargs)
            if [ -z "$full_image" ]; then continue; fi

            # è·³è¿‡å·²å­˜åœ¨çš„é•œåƒ
            if echo "$existing_source_images" | grep -qFx "$full_image"; then
              echo "â„¹ï¸ é•œåƒ $full_image å·²å­˜åœ¨äº README.mdï¼Œè·³è¿‡ã€‚"
              continue
            fi
            
            echo "--------------------------------------------------"
            echo "===== å¼€å§‹å¤„ç† $full_image ====="
            # æ‹†åˆ†é•œåƒåå’Œæ ‡ç­¾ï¼ˆé»˜è®¤æ ‡ç­¾ä¸º latestï¼‰
            current_image=$(echo "$full_image" | cut -d':' -f1)
            current_tag=$(echo "$full_image" | cut -s -d':' -f2); [ -z "$current_tag" ] && current_tag="latest"
            # ç¡®å®šç›®æ ‡æ ‡ç­¾ï¼ˆalpine æ ‡ç­¾ç‰¹æ®Šä¿ç•™ï¼‰
            target_tag="$current_tag"
            if [[ "$current_tag" =~ "alpine" ]]; then
              target_tag="alpine"
            elif [ "${{ inputs.change_tag_to_latest }}" == "æ˜¯" ]; then
              target_tag="latest"
            fi
            # æ ‡è®°åŒæ­¥çŠ¶æ€ï¼ˆä¸¥æ ¼æŒ‰æºæ ‡ç­¾åˆ¤å®šï¼‰
            sync_status="âœ”ï¸"
            if [ "$current_tag" != "latest" ] && [ "$target_tag" != "alpine" ]; then
              sync_status="âŒ"
            fi

            # ç¡®å®šç›®æ ‡ GHCR é•œåƒåï¼ˆæœªæŒ‡å®šåˆ™è‡ªåŠ¨æå–ï¼Œæ”¯æŒåµŒå¥—è·¯å¾„ï¼‰
            current_ghcr_name="${ghcr_name_array[$i]}"
            if [ -z "$current_ghcr_name" ]; then 
              # æå–å®Œæ•´é•œåƒè·¯å¾„ï¼ˆå¦‚ "louislam/dockge" ä¿ç•™åµŒå¥—ç»“æ„ï¼‰
              IMAGE_NAME=$(echo "$current_image" | awk -F'/' '{if(NF>1) print $0; else print $1}')
            else 
              IMAGE_NAME="$current_ghcr_name"
            fi
            SOURCE_IMAGE_URI="docker://$current_image:$current_tag"
            TARGET_IMAGE_URI="docker://ghcr.io/${{ env.GHCR_USER }}/$IMAGE_NAME:$target_tag"

            # --- å¸¦é‡è¯•çš„ skopeo åŒæ­¥ ---
            echo "æºé•œåƒ: $SOURCE_IMAGE_URI"
            echo "ç›®æ ‡é•œåƒ: $TARGET_IMAGE_URI"
            retry_count=2
            sync_success=false
            for ((attempt=1; attempt<=retry_count; attempt++)); do
              if skopeo copy --all "$SOURCE_IMAGE_URI" "$TARGET_IMAGE_URI"; then
                sync_success=true
                echo "âœ… é•œåƒåŒæ­¥æˆåŠŸï¼ˆç¬¬ $attempt æ¬¡å°è¯•ï¼‰"
                break
              else
                if [ $attempt -lt $retry_count ]; then
                  echo "âš ï¸ ç¬¬ $attempt æ¬¡åŒæ­¥å¤±è´¥ï¼Œ5 ç§’åé‡è¯•..."
                  sleep 5
                else
                  echo "âŒ é•œåƒåŒæ­¥å¤±è´¥ï¼ˆå·²é‡è¯• $retry_count æ¬¡ï¼‰"
                  echo "   æ’æŸ¥æ–¹å‘ï¼š1. æºé•œåƒæ˜¯å¦å­˜åœ¨ 2. ç½‘ç»œæ˜¯å¦ç¨³å®š 3. æºé•œåƒæ˜¯å¦éœ€è¦è®¤è¯"
                fi
              fi
            done
            if [ "$sync_success" != true ]; then
              continue
            fi

            # --- ç”Ÿæˆ compose æ–‡ä»¶ï¼ˆæ”¯æŒåµŒå¥—ç›®å½•ï¼‰---
            compose_file_path="docker-compose/$IMAGE_NAME.yaml"
            # æå–çˆ¶ç›®å½•å¹¶åˆ›å»ºï¼ˆå¦‚ docker-compose/louislamï¼‰
            compose_dir=$(dirname "$compose_file_path")
            mkdir -p "$compose_dir"
            # å¤åˆ¶æ¨¡æ¿å¹¶æ›¿æ¢é•œåƒåœ°å€ï¼ˆç”¨ | åˆ†éš”ç¬¦é¿å… / å†²çªï¼‰
            cp docker-compose/example.yaml "$compose_file_path"
            sed -i "s|ghcr.io\/${{ env.GHCR_USER }}\/IMAGE:TAG|${TARGET_IMAGE_URI#docker://}|g" "$compose_file_path"
            echo "âœ… å·²ç”Ÿæˆ compose æ–‡ä»¶ï¼š$compose_file_path"

            # --- å‡†å¤‡ README è¡¨æ ¼æ•°æ®ï¼ˆæ ‡å‡†åŒ–æ ¼å¼ï¼‰---
            pull_cmd="ghcr.io/${{ env.GHCR_USER }}/$IMAGE_NAME"
            if [ "$target_tag" != "latest" ]; then
              pull_cmd="$pull_cmd:$target_tag"
            fi
            pull_cmd="\`$pull_cmd\`"
            # ç”Ÿæˆ compose æ–‡ä»¶çš„ GitHub é“¾æ¥
            compose_file="[yaml](https://github.com/${{ github.repository }}/blob/main/$compose_file_path)"
            # è®°å½• UTC æ›´æ–°æ—¶é—´
            update_time=$(date -u "+%Y-%m-%d %H:%M:%S")
            # æ‹¼æ¥è¡¨æ ¼è¡Œæ•°æ®ï¼ˆç¡®ä¿ 5 åˆ—å®Œæ•´ï¼Œæ¸…ç†ç©ºæ ¼ï¼‰
            new_line_data="$(echo "$full_image" | xargs)${UNIQUE_SEPARATOR}$(echo "$pull_cmd" | xargs)${UNIQUE_SEPARATOR}$(echo "$compose_file" | xargs)${UNIQUE_SEPARATOR}$(echo "$sync_status" | xargs)${UNIQUE_SEPARATOR}$(echo "$update_time" | xargs)"
            NEW_ROWS_DATA+="${new_line_data}\n"
          done

          # æ— æ–°é•œåƒæ—¶é€€å‡º
          if [ -z "$NEW_ROWS_DATA" ]; then
            echo "--------------------------------------------------"
            echo "â„¹ï¸ æ²¡æœ‰æ–°çš„é•œåƒè¢«æ·»åŠ ï¼Œæ— éœ€æ›´æ–° README.mdã€‚"
            exit 0
          fi

          # --- 3. æ›´æ–° README è¡¨æ ¼ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šå…¼å®¹ mawk è¯­æ³•ï¼‰---
          echo "--------------------------------------------------"
          echo "å¼€å§‹æ›´æ–° README.md..."
          # æå–å·²æœ‰è¡¨æ ¼è¡Œï¼ˆä»…ä¿ç•™æœ‰æ•ˆæ•°æ®è¡Œï¼‰
          existing_rows=$(awk '
            $0 == "'"${TABLE_TITLE}"'" { in_table=1; next }
            in_table {
              if (/^\| [0-9]/) { print }
              if (!/^\|/ && !/^$/) { in_table=0 }
            }
          ' README.md)

          # åˆå¹¶æ–°æ—§è¡Œå¹¶æŒ‰é•œåƒåæ’åºï¼ˆä¿®å¤ç‰ˆï¼šè§£å†³ mawk è¯­æ³•æŠ¥é”™+æ ¼å¼é”™ä¹±ï¼‰
          sorted_table_rows=$(
            {
              # æ¸…ç†å·²æœ‰è¡Œï¼šä¿ç•™ç¬¬2-6åˆ—ï¼Œæ ‡å‡†åŒ–æ ¼å¼
              echo "$existing_rows" | awk -F'|' '
                BEGIN{OFS="|"}
                {
                  for (i=2; i<=6; i++) { gsub(/^[ \t]+|[ \t]+$/, "", $i) }
                  if ($2 != "") { printf("| %s | %s | %s | %s | %s |\n", $2, $3, $4, $5, $6) }
                }
              # å¤„ç†æ–°è¡Œï¼šå¼ºåˆ¶5åˆ—æ ¼å¼ï¼Œæ¸…ç†ç©ºæ ¼
              echo -e "$NEW_ROWS_DATA" | sed '/^$/d' | awk -F"${UNIQUE_SEPARATOR}" '
                BEGIN{OFS="|"}
                {
                  for (i=1; i<=5; i++) { gsub(/^[ \t]+|[ \t]+$/, "", $i) }
                  printf("| %s | %s | %s | %s | %s |\n", $1, $2, $3, $4, $5)
                }
              '
            } | awk -F'|' '
              # æå–æ’åºé”®ï¼šæŒ‰é•œåƒåï¼ˆå…¼å®¹åµŒå¥—è·¯å¾„ï¼Œå…¼å®¹æ‰€æœ‰ awk ç‰ˆæœ¬ï¼‰
              {
                pull_col = $3;
                gsub(/`/, "", pull_col);
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", pull_col);
                # æ­¥éª¤1ï¼šä»å³å¾€å·¦å–æœ€åä¸¤ä¸ª "/" ä¹‹é—´çš„å†…å®¹ï¼ˆå¦‚ "a/b/c:d" â†’ "b/c:d"ï¼‰
                img_part = pull_col;
                n = split(img_part, arr, "/");
                if (n >= 2) {
                  img_part = arr[n-1] "/" arr[n];
                }
                # æ­¥éª¤2ï¼šå»æ‰æ ‡ç­¾ï¼ˆå¦‚ "b/c:d" â†’ "b/c"ï¼‰
                gsub(/:[^:]+$/, "", img_part);
                # æ­¥éª¤3ï¼šå»æ‰å‰ç¼€ USER/ï¼ˆå¦‚ "louislam/dockge" â†’ "dockge"ï¼‰
                gsub(/^[^\/]+\//, "", img_part);
                # è‹¥æå–å¤±è´¥ï¼Œç”¨åŸ pull_col ä½œä¸ºé”®
                img_key = (img_part == "") ? pull_col : img_part;
                print tolower(img_key) "@@@" $0;
              }
            ' | sort | sed 's/^.*@@@//' | awk '
              # é‡æ–°æ·»åŠ åºå·ï¼Œæ ‡å‡†åŒ–é—´è·ï¼ˆä¸è¡¨å¤´å¯¹é½ï¼‰
              BEGIN{count=1; OFS="|"}
              {
                printf("| %-2d | %s\n", count++, substr($0, 3))
              }
            '
          )

          # ç”Ÿæˆæ–°è¡¨æ ¼ï¼ˆæ ‡å‡†åŒ–è¡¨å¤´+å†…å®¹ï¼‰
          {
            echo "${TABLE_TITLE}"
            echo ""
            echo "|   | æºé•œåƒ                     | pull é•œåƒ                              | docker-compose                                                                 | åŒæ­¥ | æ›´æ–°æ—¶é—´ï¼ˆUTCï¼‰       |"
            echo "|----|----------------------------|---------------------------------------|--------------------------------------------------------------------------------|------|-----------------------|"
            echo "$sorted_table_rows"
          } > new_table.tmp

          # æ›¿æ¢ README ä¸­çš„æ—§è¡¨æ ¼
          awk '
            BEGIN { replaced=0 }
            $0 == "'"${TABLE_TITLE}"'" && !replaced {
              while ((getline line < "new_table.tmp") > 0) { print line }
              close("new_table.tmp");
              replaced=1;
              skipping=1;
              next;
            }
            skipping {
              if (!/^\|/ && !/^$/) { skipping=0 } else { next }
            }
            { print }
          ' README.md > README.tmp && mv README.tmp README.md
          rm new_table.tmp

          # --- 4. è¡¨æ ¼æ ¼å¼æ ¡éªŒï¼ˆé¿å…é”™ä¹±æäº¤ï¼‰---
          echo "ğŸ” æ ¡éªŒ README è¡¨æ ¼æ ¼å¼..."
          # æ­£å¸¸è¡Œåº”åŒ…å« 7 ä¸ª "|"ï¼ˆå¯¹åº” 5 åˆ—æ•°æ®+åºå·åˆ—ï¼‰
          invalid_rows=$(grep -n "|" README.md | awk -F'|' 'NF != 7' | wc -l)
          if [ "$invalid_rows" -gt 0 ]; then
            echo "âŒ å‘ç° $invalid_rows è¡Œè¡¨æ ¼æ ¼å¼é”™è¯¯ï¼ˆç¼ºå¤±åˆ—ï¼‰ï¼Œç»ˆæ­¢æäº¤ã€‚"
            grep -n "|" README.md | awk -F'|' 'NF != 7'
            exit 1
          fi

          # --- 5. æäº¤æ›´æ”¹åˆ°ä»“åº“ ---
          git add README.md docker-compose/
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ–°çš„é•œåƒæˆ–æ–‡ä»¶å˜æ›´å¯æäº¤ã€‚"
          else
            # æäº¤ä¿¡æ¯åŒ…å«æ‰€æœ‰æ–°åŒæ­¥çš„é•œåƒ
            new_images=$(echo -e "$NEW_ROWS_DATA" | sed '/^$/d' | cut -d"${UNIQUE_SEPARATOR}" -f1 | tr '\n' ' ')
            git commit -m "chore(sync): åŒæ­¥æ–°é•œåƒ $new_images å¹¶æ›´æ–° README"
            git push
            echo "âœ… æ‰€æœ‰å˜æ›´å·²æäº¤åˆ°ä»“åº“"
          fi
