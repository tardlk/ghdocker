name: Docker Image Sync

on:
  schedule:
    - cron: '0 2 * * *' # 每天北京时间 10 点执行（UTC 2 点）
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract mirrors from README
        run: |
          # 提取 README 中表格的行（去掉表头和空行）
          sed -n '/<!--SYNC-TABLE-START-->/,/<!--SYNC-TABLE-END-->/p' README.md \
            | grep '|' \
            | tail -n +4 \
            > old_table.txt

          # 提取源镜像列表
          MIRRORS=($(awk -F'|' '{gsub(/`/, "", $2); gsub(/^[ \t]+|[ \t]+$/, "", $2); if($2!="无更新" && $2!="") print $2}' old_table.txt))

          if [ ${#MIRRORS[@]} -eq 0 ]; then
            echo "❌ 没有在 README 表格中找到源镜像，请先在表格中添加。"
            exit 1
          fi

          echo "MIRRORS_LIST=${MIRRORS[*]}" >> $GITHUB_ENV

      - name: Sync Docker images (preserve old content + remarks)
        run: |
          set -e
          LAST_UPDATE=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')

          echo "最后更新时间（北京时间）：$LAST_UPDATE" > sync_table.md
          echo "" >> sync_table.md
          echo "| 源镜像 | 同步后镜像（可复制） | 更新时间（北京时间） | 备注 |" >> sync_table.md
          echo "| ------ | ------------------- | -------------------- | ---- |" >> sync_table.md

          TMP_FILE=$(mktemp)

          # 读取旧表格到关联数组
          declare -A OLD_MIRROR OLD_REMARK
          while IFS='|' read -r _ src mirror time remark _; do
            src_clean=$(echo "$src" | tr -d '`' | xargs)
            mirror_clean=$(echo "$mirror" | xargs)
            remark_clean=$(echo "$remark" | xargs)
            OLD_MIRROR["$src_clean"]="$mirror_clean"
            OLD_REMARK["$src_clean"]="$remark_clean"
          done < old_table.txt

          for IMAGE in ${MIRRORS_LIST}; do
            TARGET="ghcr.io/${{ github.repository_owner }}/$IMAGE"
            REMARK="${OLD_REMARK[$IMAGE]}"

            echo "检查 $IMAGE 是否有更新..."
            if ! docker pull --quiet $IMAGE; then
              echo "❌ $IMAGE 拉取失败"
              NOW=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
              echo "$NOW| \`$IMAGE\` | ❌ 拉取失败 | $NOW | $REMARK |" >> "$TMP_FILE"
              continue
            fi

            SRC_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' $IMAGE | cut -d'@' -f2)

            docker pull --quiet $TARGET || true
            DEST_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' $TARGET 2>/dev/null | cut -d'@' -f2 || true)

            if [ "$SRC_DIGEST" != "$DEST_DIGEST" ]; then
              echo "发现更新，开始同步 $IMAGE..."
              docker tag $IMAGE $TARGET
              docker push $TARGET
              NOW=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
              echo "$NOW| \`$IMAGE\` | \`docker pull $TARGET\` | $NOW | $REMARK |" >> "$TMP_FILE"
            else
              echo "$IMAGE 无更新，保留原同步后镜像列内容"
              NOW=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
              old_val="${OLD_MIRROR[$IMAGE]}"
              if [ -z "$old_val" ] || [ "$old_val" = "❌ 拉取失败" ]; then
                old_val="\`docker pull $TARGET\`"
              fi
              echo "$NOW| \`$IMAGE\` | $old_val | $NOW | $REMARK |" >> "$TMP_FILE"
            fi
          done

          sort -r "$TMP_FILE" | cut -d'|' -f2- >> sync_table.md

      - name: Update README.md
        run: |
          sed -i '/<!--SYNC-TABLE-START-->/,/<!--SYNC-TABLE-END-->/d' README.md
          {
            echo "<!--SYNC-TABLE-START-->"
            echo "## 📦 镜像同步状态"
            cat sync_table.md
            echo "<!--SYNC-TABLE-END-->"
          } >> README.md

      - name: Commit changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "更新镜像同步表格（保留原内容+备注列） [skip ci]" || echo "No changes to commit"
          git push
