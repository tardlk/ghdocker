name: åŒæ­¥ Docker é•œåƒ â†’ ghcr.io

permissions:
  packages: write
  contents: write

on:
  workflow_dispatch:
    inputs:
      images:
        description: "è¦åŒæ­¥çš„ Docker é•œåƒåˆ—è¡¨ï¼Œæ ¼å¼ä¸º 'é•œåƒ1:æ ‡ç­¾1,é•œåƒ2:æ ‡ç­¾2,é•œåƒ3:æ ‡ç­¾3'"
        required: true
        default: ""
      ghcr_names:
        description: "å¯¹åº”çš„åŒæ­¥åçš„é•œåƒåç§°åˆ—è¡¨ï¼Œæ ¼å¼ä¸º 'åç§°1,åç§°2,åç§°3'ï¼Œå¦‚æœæŸä¸ªé•œåƒä¸éœ€è¦æŒ‡å®šåç§°ï¼Œåˆ™ç”¨é€—å·å¡«å……ï¼Œä¾‹å¦‚ ',,my-image' è¡¨ç¤ºç¬¬ä¸‰ä¸ªé•œåƒåŒæ­¥ååç§°ä¸º my-imageï¼Œå‰ä¸¤ä¸ªè‡ªåŠ¨æå–"
        required: false
        default: ""
      change_tag_to_latest:
        description: "åŒæ­¥åæ˜¯å¦å°†é•œåƒæ ‡ç­¾æ”¹ä¸º latest (æ˜¯/å¦)"
        required: true
        type: choice
        options:
          - "æ˜¯"
          - "å¦"
        default: "æ˜¯"

jobs:
  docker-image-sync:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: sudo apt-get update && sudo apt-get install -y jq skopeo

      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® GHCR_USER ç¯å¢ƒå˜é‡
        id: set_ghcr_user
        run: echo "GHCR_USER=$(echo '${{ github.actor }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: ç™»å½•åˆ° GitHub å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_USER }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: åŒæ­¥é•œåƒå¹¶æ›´æ–° README
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase

          # --- 1. é•œåƒåŒæ­¥ä¸ä¿¡æ¯æ”¶é›† ---
          NEW_ROWS_DATA=""
          UNIQUE_SEPARATOR="%%%"
          # ä¿®æ­£è¡¨æ ¼æ ‡é¢˜ä¸ºäºŒçº§æ ‡é¢˜ï¼ˆåŒ¹é… READMEï¼‰
          TABLE_TITLE="## ğŸ—‚ï¸ å·²åŒæ­¥çš„ Docker é•œåƒ"

          # æå–å·²å­˜åœ¨çš„æºé•œåƒï¼ˆé€‚é…æ–°è¡¨æ ¼ç»“æ„ï¼‰
          existing_source_images=$(awk '
            $0 == "'"${TABLE_TITLE}"'" { in_table=1; next }
            in_table {
              if (/^\| [0-9]/) { 
                match($0, /\| *[^|]+ *\| *([^|]+) *\|/);
                if (RSTART) { print substr($0, RSTART, RLENGTH) }
              }
              if (!/^\|/ && !/^$/) { in_table=0 }
            }
          ' README.md | sed -e 's/|//g' -e 's/^[ \t]*//;s/[ \t]*$//')

          IFS=',' read -r -a image_array <<< "${{ inputs.images }}"
          IFS=',' read -r -a ghcr_name_array <<< "${{ inputs.ghcr_names }}"

          for i in "${!image_array[@]}"; do
            full_image=$(echo "${image_array[$i]}" | xargs)
            if [ -z "$full_image" ]; then continue; fi

            if echo "$existing_source_images" | grep -qFx "$full_image"; then
              echo "é•œåƒ $full_image å·²å­˜åœ¨äº README.mdï¼Œè·³è¿‡ã€‚"
              continue
            fi
            
            echo "--------------------------------------------------"
            echo "===== å¼€å§‹å¤„ç† $full_image ====="
            current_image=$(echo "$full_image" | cut -d':' -f1)
            current_tag=$(echo "$full_image" | cut -s -d':' -f2); [ -z "$current_tag" ] && current_tag="latest"
            target_tag="$current_tag"; [[ "$current_tag" =~ "alpine" ]] && target_tag="alpine" || { [ "${{ inputs.change_tag_to_latest }}" == "æ˜¯" ] && target_tag="latest"; }
            
            if [ "$current_tag" == "latest" ] || [ "$target_tag" == "alpine" ]; then 
              sync_status="âœ”ï¸"
            else 
              sync_status="âŒ"
            fi
            
            current_ghcr_name="${ghcr_name_array[$i]}"
            if [ -z "$current_ghcr_name" ]; then 
              IMAGE_NAME=$(basename "$current_image")
            else 
              IMAGE_NAME="$current_ghcr_name"
            fi

            SOURCE_IMAGE_URI="docker://$current_image:$current_tag"
            TARGET_IMAGE_URI="docker://ghcr.io/${{ env.GHCR_USER }}/$IMAGE_NAME:$target_tag"
            
            # åŒæ­¥é•œåƒï¼ˆä¿ç•™æ ¸å¿ƒé€»è¾‘ï¼‰
            echo "æºé•œåƒ: $SOURCE_IMAGE_URI"
            echo "ç›®æ ‡é•œåƒ: $TARGET_IMAGE_URI"
            
            if skopeo copy --all "$SOURCE_IMAGE_URI" "$TARGET_IMAGE_URI"; then
              echo "âœ… é•œåƒåŒæ­¥æˆåŠŸ"
            else
              echo "âŒ é•œåƒåŒæ­¥å¤±è´¥ï¼Œè·³è¿‡è¯¥é•œåƒã€‚"
              continue
            fi

            # å‡†å¤‡æ–°è¡Œæ•°æ®ï¼ˆç§»é™¤ docker-compose åˆ—ï¼Œæ·»åŠ æ›´æ–°æ—¶é—´ï¼‰
            pull_cmd="ghcr.io/${{ env.GHCR_USER }}/$IMAGE_NAME"
            [ "$target_tag" != "latest" ] && pull_cmd="$pull_cmd:$target_tag"
            pull_cmd="\`$pull_cmd\`"
            # æ–°å¢æ›´æ–°æ—¶é—´ï¼ˆå½“å‰æ—¥æœŸï¼‰
            update_time=$(date +%Y-%m-%d)
            
            # 4 åˆ—æ•°æ®ï¼šæºé•œåƒ | pull é•œåƒ | åŒæ­¥ | æ›´æ–°æ—¶é—´
            new_line_data="${full_image}${UNIQUE_SEPARATOR}${pull_cmd}${UNIQUE_SEPARATOR}${sync_status}${UNIQUE_SEPARATOR}${update_time}"
            NEW_ROWS_DATA+="${new_line_data}\n"
          done

          if [ -z "$NEW_ROWS_DATA" ]; then
            echo "æ²¡æœ‰æ–°çš„é•œåƒè¢«æ·»åŠ ï¼Œæ— éœ€æ›´æ–° README.mdã€‚"
            exit 0
          fi

          # --- 2. README æ›´æ–°ã€æ’åºä¸é‡å†™ ---
          echo "å¼€å§‹æ›´æ–° README.md..."

          # æå–ç°æœ‰è¡¨æ ¼è¡Œ
          existing_rows=$(awk '
            $0 == "'"${TABLE_TITLE}"'" { in_table=1; next }
            in_table {
              if (/^\| [0-9]/) { print }
              if (!/^\|/ && !/^$/) { in_table=0 }
            }
          ' README.md)

          # æ’åºå¹¶ç”Ÿæˆæ–°è¡¨æ ¼è¡Œï¼ˆé€‚é… 4 åˆ—ï¼‰
          sorted_table_rows=$(
            {
              # æ¸…é™¤ç°æœ‰è¡Œçš„åºå·
              echo "$existing_rows" | sed 's/^| [0-9]\{1,\} *|/|/'
              # å¤„ç†æ–°è¡Œï¼ˆ4 åˆ—æ ¼å¼ï¼‰
              echo -e "$NEW_ROWS_DATA" | sed '/^$/d' | awk -F"${UNIQUE_SEPARATOR}" '{printf("| %s | %s | %s | %s |\n", $1, $2, $3, $4)}'
            } | awk -F'|' '
              {
                # åŸºäº pull é•œåƒåˆ—ï¼ˆç¬¬ 2 åˆ—ï¼‰æ’åº
                key = $2;
                gsub(/`/, "", key);
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", key);
                sub(/.*\/|:[^:]*$/, "", key);
                print key "@@@" $0;
              }
            ' | sort -f | sed 's/^.*@@@//' | awk 'BEGIN{count=1} {printf("| %-3s %s\n", count++, $0)}'
          )

          # ç”Ÿæˆæ–°è¡¨æ ¼ï¼ˆ4 åˆ—è¡¨å¤´ï¼‰
          {
            echo "${TABLE_TITLE}"
            echo ""
            echo "|   | æºé•œåƒ | pull é•œåƒ | åŒæ­¥ | æ›´æ–°æ—¶é—´ |"
            echo "| ---- | -------- | --------- | ---- | -------- |"
            echo "$sorted_table_rows"
          } > new_table.tmp

          # æ›¿æ¢ README ä¸­çš„è¡¨æ ¼
          awk '
            BEGIN { replaced=0 }
            $0 == "'"${TABLE_TITLE}"'" && !replaced {
              while ((getline line < "new_table.tmp") > 0) { print line }
              close("new_table.tmp");
              replaced=1;
              skipping=1;
              next;
            }
            skipping {
              if (!/^\|/ && !/^$/) { skipping=0 } else { next }
            }
            { print }
          ' README.md > README.tmp && mv README.tmp README.md
          rm new_table.tmp

          # æäº¤æ›´æ”¹ï¼ˆç§»é™¤ docker-compose ç›®å½•çš„æäº¤ï¼‰
          git add README.md
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°çš„é•œåƒæˆ–æ–‡ä»¶å˜æ›´å¯æäº¤ã€‚"
          else
            git commit -m "chore(sync): åŒæ­¥æ–°é•œåƒå¹¶è‡ªåŠ¨æ’åºæ›´æ–°README"
            git push
          fi
