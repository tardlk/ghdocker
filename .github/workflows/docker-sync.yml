name: Docker Image Sync

on:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´ 10 ç‚¹æ‰§è¡Œï¼ˆUTC 2 ç‚¹ï¼‰
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»“åº“ä»£ç 
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      # 2. ç™»å½• GHCR
      - name: ç™»å½• GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. å°† GitHub ç”¨æˆ·åè½¬ä¸ºå°å†™ï¼ˆé˜²æ­¢ GHCR æŠ¥é”™ï¼‰
      - name: è½¬æ¢ç”¨æˆ·åä¸ºå°å†™
        run: |
          echo "OWNER_LC=${OWNER,,}" >> $GITHUB_ENV
        env:
          OWNER: ${{ github.repository_owner }}

      # 4. ä» README ä¸­æå–é•œåƒåˆ—è¡¨
      - name: ä» README æå–é•œåƒåˆ—è¡¨
        run: |
          sed -n '/<!--SYNC-TABLE-START-->/,/<!--SYNC-TABLE-END-->/p' README.md \
            | grep '|' \
            | tail -n +4 \
            > old_table.txt

          MIRRORS=($(awk -F'|' '{gsub(/`/, "", $2); gsub(/^[ \t]+|[ \t]+$/, "", $2); if($2!="æ— æ›´æ–°" && $2!="") print $2}' old_table.txt))

          if [ ${#MIRRORS[@]} -eq 0 ]; then
            echo "âŒ æ²¡æœ‰åœ¨ README è¡¨æ ¼ä¸­æ‰¾åˆ°æºé•œåƒï¼Œè¯·å…ˆåœ¨è¡¨æ ¼ä¸­æ·»åŠ ã€‚"
            exit 1
          fi

          echo "MIRRORS_LIST=${MIRRORS[*]}" >> $GITHUB_ENV

      # 5. åŒæ­¥é•œåƒï¼ˆä¿ç•™åŸå†…å®¹ + å¤‡æ³¨åˆ— + æ—¥å¿—è®°å½•ï¼‰
      - name: åŒæ­¥é•œåƒ
        run: |
          set -e
          LAST_UPDATE=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')

          echo "æœ€åæ›´æ–°æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š$LAST_UPDATE" > sync_table.md
          echo "" >> sync_table.md
          echo "| æºé•œåƒ | åŒæ­¥åé•œåƒï¼ˆå¯å¤åˆ¶ï¼‰ | æ›´æ–°æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ | å¤‡æ³¨ |" >> sync_table.md
          echo "| ------ | ------------------- | -------------------- | ---- |" >> sync_table.md

          TMP_FILE=$(mktemp)

          # è¯»å–æ—§è¡¨æ ¼åˆ°å…³è”æ•°ç»„
          declare -A OLD_MIRROR OLD_REMARK
          while IFS='|' read -r _ src mirror time remark _; do
            src_clean=$(echo "$src" | tr -d '`' | xargs)
            mirror_clean=$(echo "$mirror" | xargs)
            remark_clean=$(echo "$remark" | xargs)
            OLD_MIRROR["$src_clean"]="$mirror_clean"
            OLD_REMARK["$src_clean"]="$remark_clean"
          done < old_table.txt

          UPDATED_IMAGES=()
          FAILED_IMAGES=()
          SKIPPED_IMAGES=()

          for IMAGE in ${MIRRORS_LIST}; do
            TARGET="ghcr.io/${OWNER_LC}/$IMAGE"
            REMARK="${OLD_REMARK[$IMAGE]}"

            echo "æ£€æŸ¥ $IMAGE æ˜¯å¦æœ‰æ›´æ–°..."
            if ! docker pull --quiet $IMAGE; then
              echo "âŒ $IMAGE æ‹‰å–å¤±è´¥"
              FAILED_IMAGES+=("$IMAGE")
              NOW=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
              echo "| \`$IMAGE\` | âŒ æ‹‰å–å¤±è´¥ | $NOW | $REMARK |" >> "$TMP_FILE"
              continue
            fi

            SRC_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' $IMAGE | cut -d'@' -f2)

            docker pull --quiet $TARGET || true
            DEST_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' $TARGET 2>/dev/null | cut -d'@' -f2 || true)

            if [ "$SRC_DIGEST" != "$DEST_DIGEST" ]; then
              echo "å‘ç°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥ $IMAGE..."
              docker tag $IMAGE $TARGET
              docker push $TARGET
              UPDATED_IMAGES+=("$IMAGE")
              NOW=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
              echo "| \`$IMAGE\` | \`docker pull $TARGET\` | $NOW | $REMARK |" >> "$TMP_FILE"
            else
              echo "$IMAGE æ— æ›´æ–°ï¼Œä¿ç•™åŸåŒæ­¥åé•œåƒåˆ—å†…å®¹"
              SKIPPED_IMAGES+=("$IMAGE")
              NOW=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
              old_val="${OLD_MIRROR[$IMAGE]}"
              if [ -z "$old_val" ] || [ "$old_val" = "âŒ æ‹‰å–å¤±è´¥" ]; then
                old_val="\`docker pull $TARGET\`"
              fi
              echo "| \`$IMAGE\` | $old_val | $NOW | $REMARK |" >> "$TMP_FILE"
            fi
          done

          sort -r "$TMP_FILE" | cut -d'|' -f2- >> sync_table.md

          echo ""
          echo "===== æœ¬æ¬¡è¿è¡Œæ‘˜è¦ ====="
          echo "âœ… æ›´æ–°çš„é•œåƒ: ${UPDATED_IMAGES[*]:-(æ— )}"
          echo "âŒ æ‹‰å–å¤±è´¥çš„é•œåƒ: ${FAILED_IMAGES[*]:-(æ— )}"
          echo "â© æ— æ›´æ–°çš„é•œåƒ: ${SKIPPED_IMAGES[*]:-(æ— )}"
          echo "======================="

      # 6. æ›´æ–° README.md
      - name: æ›´æ–° README.md
        run: |
          sed -i '/<!--SYNC-TABLE-START-->/,/<!--SYNC-TABLE-END-->/d' README.md
          {
            echo "<!--SYNC-TABLE-START-->"
            echo "## ğŸ“¦ é•œåƒåŒæ­¥çŠ¶æ€"
            cat sync_table.md
            echo "<!--SYNC-TABLE-END-->"
          } >> README.md

      # 7. æäº¤æ›´æ”¹
      - name: æäº¤æ›´æ”¹
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "æ›´æ–°é•œåƒåŒæ­¥è¡¨æ ¼ï¼ˆä¿ç•™åŸå†…å®¹+å¤‡æ³¨åˆ—+æ—¥å¿—æ‘˜è¦+ç”¨æˆ·åå°å†™ï¼‰ [skip ci]" || echo "No changes to commit"
          git push
